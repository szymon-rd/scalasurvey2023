{{ define "main" }}
<main>
  <div class="bg-gray-200 dark:bg-gray-900">
    <div class="max-w-screen-xl px-4 py-8 mx-auto">
      <div class="grid items-center gap-1 mb-8 sm:mb-0 lg:gap-12 lg:grid-cols-12">
        <div class="col-span-6 px-4 text-center lg:text-left">
          <h1
            class="mb-2 text-4xl font-extrabold leading-none tracking-tight text-gray-900 md:text-5xl xl:text-6xl dark:text-white">
            {{ .Site.Title }}
          </h1>
          <h2 class="pb-2 text-3xl font-light text-gray-800 dark:text-gray-300 md:text-4xl">
            {{ .Site.Params.Moto }}
          </h2>
          <p
            class="max-w-xl mx-auto mb-6 font-normal text-gray-900 lg:mx-0 xl:mb-2 md:text-lg xl:text-xl dark:text-gray-50">
            {{ .Site.Params.Description}}
          </p>
        </div>
        <div class="col-span-6">
          {{ $hero := resources.GetMatch "images/pages/spiral-white.png" }}

          {{ $thumb := ($hero.Fill "400x400 webp q90") }}
          {{ $large := ($hero.Fill "576x576 webp q90") }}

          <img srcset="
                        {{- with $thumb.RelPermalink -}}{{.}} 400w{{- end -}}
                        {{- with $large.RelPermalink -}}, {{.}} 576w{{- end -}}" src="{{ $hero.RelPermalink }}"
            width="100%" height="" alt="TailBliss Hero" class="w-full max-w-xl mx-auto rounded-lg" />
        </div>
      </div>
    </div>
  </div>

  <!-- More main page content here... -->

  <!-- Our mission section -->
  <div class="relative my-4 pb-4 overflow-hidden">
    <div class="lg:mx-auto lg:grid lg:max-w-7xl lg:grid-cols-2 lg:items-start lg:gap-24 lg:px-8">
      <div class="relative sm:py-8 lg:py-0">
        <div aria-hidden="true" class="hidden sm:block lg:absolute lg:inset-y-0 lg:right-0 lg:w-screen">
          <div class="absolute inset-y-0 w-full bg-gray-50 dark:bg-gray-900/10 right-1/2 rounded-r-3xl lg:right-72">
          </div><svg class="absolute -ml-3 top-8 left-1/2 lg:-right-8 lg:left-auto lg:top-12" width="404" height="392"
            fill="none" viewBox="0 0 404 392" loading="lazy">
            <defs>
              <pattern id="02f20b47-fd69-4224-a62a-4c9de5c763f7" x="0" y="0" width="20" height="20"
                patternUnits="userSpaceOnUse">
                <rect x="0" y="0" width="4" height="4" class="text-gray-200 dark:text-gray-900/60" fill="currentcolor">
                </rect>
              </pattern>
            </defs>
            <rect width="404" height="392" fill="url(#02f20b47-fd69-4224-a62a-4c9de5c763f7)"></rect>
          </svg>
        </div>
        <div class="relative w-full h-auto px-4 py-6 mx-auto sm:max-w-3xl sm:px-6 lg:px-0 lg:py-20">
          <div class="overflow-hidden shadow-xl rounded-2xl">
            {{ $p1image := resources.Get .Site.Params.P1.Image }}
            {{ with $p1image }}
            {{ with .Resize (printf "%dx%d webp q90" .Width .Height) }}
            <img imgh src={{ (resources.Get "images/global/survey.png" ).RelPermalink }} width="{{ .Width }}"
              height="{{ .Height }}" class="w-full h-auto" alt="P1" loading="lazy" />
            {{ end }}
            {{ end }}
          </div>
        </div>
      </div>
      <div class="relative max-w-md px-4 mx-auto sm:max-w-3xl sm:px-6 lg:px-0">
        <div class="md:pt-12 sm:pt-6 lg:pt-20">
          <h2 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-gray-50 sm:text-4xl">
            Scala in 2023
          </h2>
          <div class="mt-6 text-gray-900 dark:text-white">
            <div class="mt-6 space-y-6 text-gray-900 dark:text-white">

              <p class="text-lg text-gray-900 dark:text-white">
                Scala Survey 2023 was conducted to help the Scala community understand itself better. The survey consists
                of 36 questions in the areas of demographics, Scala language and its ecosystem. It received 1387 responses
                and totalled a 63.2% completion rate. Over 50% of the drop-off happened in the first question. On this page,
                we present the results of the survey in a visual form.
              </p>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="relative overflow-hidden my-8 dataquestiondiv">
    <div class="mx-auto px-4 sm:max-w-3xl sm:px-6 lg:max-w-7xl lg:items-start lg:gap-24 lg:px-8">
      <div class="py-4 md:py-6 lg:py-8">
        <h2 class="dataquestion mb-2 text-2xl font-bold tracking-tight text-gray-900 dark:text-gray-50 md:mb-4 md:text-3xl lg:mb-5 lg:text-4xl"></h2>
        <div class="relative datadiagram"></div>
      </div>
    </div>
  </div>

  <!-- CTA section -->
  {{ if .Site.Params.P5.Enabled }}
  <div class="relative pb-16 mt-6">
    <div class="max-w-md mx-auto px-7 sm:max-w-3xl lg:max-w-7xl">
      <div class="relative px-6 py-10 overflow-hidden shadow-xl bg-primary-500 rounded-2xl sm:px-12 sm:py-20">
        <div aria-hidden="true" class="absolute inset-0 -mt-72 sm:-mt-32 md:mt-0">
          <svg class="absolute inset-0 w-full h-full" preserveAspectRatio="xMidYMid slice"
            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 1463 360" loading="lazy">
            <path class="text-primary-600 text-opacity-40" fill="currentColor"
              d="M-82.673 72l1761.849 472.086-134.327 501.315-1761.85-472.086z" />
            <path class="text-primary-600 text-opacity-40" fill="currentColor"
              d="M-217.088 544.086L1544.761 72l134.327 501.316-1761.849 472.086z" />
          </svg>
        </div>
        <div class="relative">
          <div class="sm:text-center">
            <h2 class="text-3xl font-bold tracking-tight text-white sm:text-4xl">
              {{ .Site.Params.P5.Heading }}
            </h2>
            {{ range .Site.Params.P5.Content }}
            <p class="max-w-2xl mx-auto mt-6 text-lg text-primary-100">
              {{ .text }}
            </p>
            {{ end }}
          </div>
          <form action="{{ .Site.Params.P5.Action }}" class="mt-12 sm:mx-auto sm:flex sm:max-w-lg">
            <div class="flex-1 min-w-0">
              <label for="cta-email" class="sr-only">{{ .Site.Params.P5.Label }}</label>
              <input id="cta-email" type="email"
                class="block w-full px-5 py-3 text-base text-gray-900 placeholder-gray-500 border border-transparent rounded-md shadow-sm focus:border-transparent focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-primary-500"
                placeholder="{{ .Site.Params.P5.Placeholder }}">
            </div>
            <div class="mt-4 sm:mt-0 sm:ml-3">
              <button type="submit"
                class="block w-full px-5 py-3 text-base font-medium text-white bg-gray-900 border border-transparent rounded-md shadow hover:bg-black focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-primary-500 sm:px-10">
                {{ .Site.Params.P5.Button }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {{ end }}

  <script>
    (async function () {

      function mkSwatches(svg, colors, keys, descs, shiftX, shiftY) {
        const r = 6
        const dist = 3*r
        svg.append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("text-anchor", "start")
          .attr("transform", `translate(${shiftX}, ${shiftY})`)
          .selectAll("g")
          .data(keys).enter().append("circle").attr("cy", function(d,i){return 24 + i*dist}).attr("cx",shiftX + r).attr("r", r).attr("fill", function(d, i){return colors[i] })
        svg
          .append("g")
          .attr("font-family", "sans-serif")
          .attr("font-size", 10)
          .attr("text-anchor", "start")
          .attr("transform", `translate(${shiftX}, ${shiftY})`)
          .selectAll("g")
          .data(keys).enter()
          .append("text").text(function(d, i){return descs[i] }).attr("fill", "white").attr("transform", function(d, i){return `translate(${shiftX + 2*r + 8}, ${24 + i*dist + r/2 + 2})`})
          .attr("font-size", "12")


        
      }

      const data = await d3.json({{ (resources.Get "data/report.json").RelPermalink }})
      const QUESTIONS_NUM = {{ len .Site.Params.Data }}
      const blueprint = document.querySelector(".dataquestiondiv")
      const likeKeys = ["üëé",  "üö´", "ü§∑", "‚úÖ", "üëç"]
      const likeDescs = ["Would not use again", "Not interested", "Never heard of", "Would like to learn", "Would use again"]
      const likeColors = ["#b41045", "#f47159", "#ffffdd", "#38a0bc", "#137cac"]
      const numericColors = ["#35465E", "#b41045", "#f47159", "#ffffdd", "#38a0bc", "#00599b"]
      const numericDescs = ["Never heard of", "Never", "Rarely", "From time to time", "Often", "Very often"]
      
      const numericKeys = ["ü§∑", "1", "2", "3", "4", "5"]
      for (let i = 0; i < data.length; i++) {
        const elem = blueprint.cloneNode(true)
        elem.querySelector(".dataquestion").innerHTML = data[i]["question"]
        elem.querySelector(".datadiagram").id = `diagramq${i}`
        blueprint.parentNode.insertBefore(elem, blueprint.nextSibling)
        let question = data[i]
        if (question.tpe == "S") {
          const limitedAnswers = question.answers.slice(0, 15).filter(a => a.percentage >= 0.01)

          // Specify the chart‚Äôs dimensions, based on a bar‚Äôs height.
          const barHeight = 25;
          const marginTop = 30;
          const marginRight = 100;
          const marginBottom = 10;
          const marginLeft = 200;
          const width = 928;
          const height = Math.ceil((limitedAnswers.length + 0.1) * barHeight) + marginTop + marginBottom;

          // Create the scales.
          const x = d3.scaleLinear()
              .domain([0, 1.0])
              .range([marginLeft, width - marginRight]);

          const y = d3.scaleBand()
              .domain(limitedAnswers.map(a => a.answer))
              .rangeRound([marginTop, height - marginBottom])
              .padding(0.1);

          // Create a value format.
          const format = x.tickFormat(20, "%");

          // append the svg object to the body of the page
          var svg = d3.select(`#diagramq${i}`)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", [0, 0, width, height])
            // .attr("style", "max-width: 100%; height: auto;")
            .attr("class", `poll-mono`);

          // Append a rect for each letter.
          svg.append("g")
              .attr("fill", "steelblue")
            .selectAll()
            .data(limitedAnswers)
            .join("rect")
              .attr("x", x(0))
              .attr("y", (d) => y(d.answer))
              .attr("width", (d) => x(d.percentage) - x(0))
              .attr("height", y.bandwidth());
          
          // Append a label for each letter.
          svg.append("g")
              .attr("fill", "white")
              .attr("text-anchor", "end")
            .selectAll()
            .data(limitedAnswers)
            .join("text")
              .attr("x", (d) => x(d.percentage))
              .attr("y", (d) => y(d.answer) + y.bandwidth() / 2)
              .attr("dy", "0.35em")
              .attr("dx", -4)
              .attr("class", "text-black")
              .text((d) => format(d.percentage))
            .call((text) => text.filter(d => d.percentage < 0.09) // short bars
              .attr("dx", +4)
              .attr("fill", "black")
              .attr("class", "text-white")
              .attr("text-anchor", "start"));

          // Create the axes.
          svg.append("g")
              .attr("transform", `translate(0,${marginTop})`)
              .call(d3.axisTop(x).ticks(width / 80, "%"))
              .call(g => g.select(".domain").remove());

          svg.append("g")
              .attr("transform", `translate(${marginLeft},0)`)
              .call(d3.axisLeft(y).tickSizeOuter(0));

          svg.selectAll("text")
            .attr("font-size", "18")
            .style("fill", "#FFFFFF")
          svg.selectAll(".text-black")
            .style("fill", "#000000")
          svg.selectAll("path")
            .style("stroke", "#FFFFFF")
          svg.selectAll("line")
            .style("stroke", "#FFFFFF")
          svg.selectAll("rect")
            .style("fill", "#ffffdd")
        } else {
          const width = 928;
          const marginTop = 50;
          const marginRight = 30;
          const marginBottom = 16;
          const marginLeft = 400;
          // Determine the series that need to be stacked.
          const isLikeScale = question.answers.map(d => d.answer).every(d => likeKeys.includes(d))
          const keys = isLikeScale ? likeKeys : numericKeys

          const series = d3.stack()
              .keys(keys) // distinct series keys, in input order
              .value(([, D], key) => (D.get(key) == undefined ? 0 : D.get(key).percentage)) // get value for each series key and stack
              .offset(d3.stackOffsetExpand)
            (d3.index(question.answers, d => d.subq, d => d.answer)); // group by stack then series key
                    // Compute the height from the number of stacks.
          const height = series[0].length * 25 + marginTop + marginBottom;

          // Prepare the scales for positional and color encodings.
          const x = d3.scaleLinear()
              .domain([0, d3.max(series, d => d3.max(d, d => d[1]))])
              .range([marginLeft, width - marginRight]);

          const y = d3.scaleBand()
              .domain(d3.groupSort(question.answers, (D) => {
                // console.log(D);
                if(isLikeScale) return D.find(d => d.answer == "üëç") == undefined ? 0 : -D.find(d => d.answer == "üëç").percentage / d3.sum(D, d => d.percentage);
                else return D.find(d => d.answer == "5") == undefined ? 0 : -D.find(d => d.answer == "5").percentage / d3.sum(D, d => d.percentage);
              }, d => d.subq))
              .range([marginTop, height - marginBottom])
              .padding(0.08);
          const color = d3.scaleOrdinal()
              .domain(series.map(d => d.key))
              .range(isLikeScale ? likeColors : numericColors)
              .unknown("#ccc");

          // A function to format the value in the tooltip.
          const formatValue = x => isNaN(x) ? "N/A" : x.toLocaleString("en")

          // Create the SVG container.
          const svg = d3.select(`#diagramq${i}`)
              .append("svg")
              .attr("width", width)
              .attr("height", height)
              .attr("viewBox", [0, 0, width, height])
              // .attr("style", `max-width: 100%; height: auto;`)
              .attr("class", `poll-multi`);

          // Append a group for each series, and a rect for each element in the series.
          svg.append("g")
            .selectAll()
            .data(series)
            .join("g")
              .attr("fill", d => color(d.key))
            .selectAll("rect")
            .data(D => D.map(d => (d.key = D.key, d)))
            .join("rect")
              .attr("x", d => x(d[0]))
              .attr("y", d => y(d.data[0]))
              .attr("height", y.bandwidth())
              .attr("width", d => x(d[1]) - x(d[0]))
            .append("title")
              .text(d => `${d.data[0]} ${d.key}\n${formatValue(d.data[1].get(d.key) == undefined ? 0 : d.data[1].get(d.key).percentage)}`);

          // Append the horizontal axis.
          svg.append("g")
              .attr("transform", `translate(0,${marginTop})`)
              .call(d3.axisTop(x).ticks(width / 100, "%"))
              .call(g => g.selectAll(".domain").remove());

          // Append the vertical axis.
          svg.append("g")
              .attr("transform", `translate(${marginLeft},0)`)
              .call(d3.axisLeft(y).tickSizeOuter(0))
              .call(g => g.selectAll(".domain").remove());

          svg.selectAll("text")
            .attr("font-size", "18")
            .style("fill", "#FFFFFF")
          svg.selectAll("path")
            .style("stroke", "#FFFFFF")
          svg.selectAll("line")
            .style("stroke", "#FFFFFF")

          const newSvg = d3.select(`#diagramq${i}`)
              .append("svg")
              .attr("width", 256)
              .attr("height", 128)
              .attr("viewBox", [0, 0, 36, 128])
              // .attr("style", `max-width: 100%; height: auto;`)
              .attr("class", `poll-legend`);
          mkSwatches(newSvg, isLikeScale ? likeColors : numericColors, keys, isLikeScale ? likeDescs : numericDescs, 0, 0)
        }
    }

      blueprint.remove()
    })();
  </script>
</main>
{{ end }}